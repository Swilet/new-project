{% extends "blog/base.html" %}
<h1>여기가 진짜 내 파일 맞냐!!!</h1> <div class="nm-card mb-4"></div>
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
  <div class="nm-card mb-4">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="h2 mb-1">{{ post.title }}</h1>
            <p class="small text-secondary mb-3">
                {{ post.created_at|date:"Y년 n월 j일" }}
            </p>
        </div>
        <form action="{% url 'blog:like_post' post.pk %}" method="post" class="ms-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                <i class="bi {% if is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i> 좋아요 ({{ post.total_likes }})
            </button>
        </form>
    </div>
      <div class="d-flex flex-wrap gap-2 mb-4">
        {% for cat in post.categories.all %}
          <a href="{% url 'blog:posts_by_category' cat.name %}" class="badge text-bg-light text-decoration-none">{{ cat.name }}</a>
        {% endfor %}
        {% for tag in post.tags.all %}
          <a href="{% url 'blog:posts_by_tag' tag.name %}" class="badge text-bg-primary text-decoration-none">{{ tag.name }}</a>
        {% endfor %}
      </div>
      <div>
        {{ post.content|linebreaks }}
      </div>
      <hr class="my-4">
      <div class="text-end">
        <a href="{% url 'blog:post_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-list"></i> 목록으로
        </a>
    </div>
  </div>

  <!-- Comments section -->
  <div class="nm-card mb-4">
      <h4 class="mb-3">({{ comments.count }}) 댓글</h4>
      {% for comment in comments %}
        <div class="d-flex gap-3 py-3 {% if not forloop.last %}border-bottom{% endif %}">
            <div class="rounded-circle bg-secondary-subtle d-flex align-items-center justify-content-center flex-shrink-0" style="width:40px;height:40px;">
                <i class="bi bi-person-fill text-secondary fs-5"></i>
            </div>
            <div class="w-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <span class="fw-bold">{{ comment.author }}</span>
                        <span class="text-secondary small ms-2">{{ comment.created_on|date:"Y.m.d H:i" }}</span>
                    </div>
                    {% if user.username == comment.author %}
                    <form action="{% url 'blog:delete_comment' post.pk comment.pk %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?');" title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
                <p class="mb-0 mt-1 text-secondary">{{ comment.body|linebreaksbr }}</p>
            </div>
        </div>
      {% empty %}
        <p class="text-secondary my-3">아직 댓글이 없습니다.</p>
      {% endfor %}
  </div>

  <!-- Comment form -->
  <div class="nm-card">
    <h5 class="mb-3">댓글 남기기</h5>
  
    <form method="post">
      {% csrf_token %}

    {% if not user.is_authenticated %}
    <div class="mb-3">
        <label for="author" class="form-label">이름</label>
        <input type="text" name="author" id="author" class="form-control" required>
    </div>
    {% endif %}

    <div class="mb-3">
        <label for="{{ comment_form.body.id_for_label }}" class="form-label">내용</label>
        {{ comment_form.body }}
    </div>

    <button type="submit" class="btn btn-primary">댓글 달기</button>
  </form>
</div>
{% endblock %}
